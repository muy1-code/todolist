$(function () {
    // -------------------------- ğŸ˜ å°è£…å‡½æ•°saveData()ï¼šè®¾ç½®æœ¬åœ°å­˜å‚¨æ•°æ®ï¼Œä¼ å…¥å¯¹è±¡ --------------------------
    function saveData(obj) {
        localStorage.setItem('todo', JSON.stringify(obj)); // å¯¹è±¡å¿…é¡»è½¬æ¢ä¸ºå­—ç¬¦ä¸² 
    }
    // -------------------------- ğŸ˜ å°è£…å‡½æ•° getData()ï¼šè¯»å–æœ¬åœ°å­˜å‚¨çš„æ•°æ®ï¼Œè¿”å›æ•°ç»„ --------------------------
    function getData() {
        let str = localStorage.getItem('todo');
        if (str !== null) {
            let arr = JSON.parse(str); // æœ¬åœ°å­˜å‚¨é‡Œé¢çš„æ•°æ®æ˜¯å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬éœ€è¦å¯¹è±¡æ ¼å¼ï¼ŒJSON.parse(str)
            return arr;
        } else {
            return [];
        }
    }
    // -------------------------- ğŸ˜ å°è£…å‡½æ•° load()ï¼šæœ¬åœ°å­˜å‚¨æ•°æ®æ¸²æŸ“åˆ°é¡µé¢ä¸­ --------------------------
    function load() {
        let arr = getData(); // è·å–æœ¬åœ°æ•°æ®ï¼šæ•°ç»„
        let doingNum = 0; // å­˜å‚¨æ­£åœ¨è¿›è¡Œäº‹é¡¹æ•°é‡
        let doneNum = 0; // å­˜å‚¨å·²ç»å®Œæˆäº‹é¡¹æ•°é‡

        $('.doing,.done').html(''); // æ¯æ¬¡æ¸²æŸ“éå†ä¹‹å‰ï¼Œéƒ½è¦å…ˆæ¸…ç©º.doingå’Œ.doneçš„å†…å®¹

        $.each(arr, function (i, ele) { // éå†æ•°ç»„,æ¯æ¬¡éƒ½åˆ›å»ºä¸€ä¸ªli
            var li = $('<li></li>'); // åˆ›å»ºli
            $(li).attr('index', i) // æ¯æ¬¡æ¸²æŸ“éƒ½ä¼šå¯¹liæ·»åŠ è‡ªå®šä¹‰å±æ€§ index ï¼Œå€¼ä¸ºiï¼Œæ–¹ä¾¿åæœŸæ‰¾å‡ºè¢«ç‚¹å‡»liæ˜¯å“ªä¸€ä¸ª

            $(li).append('<input type="checkbox" name="" id="" class="ok">'); // å¾€liä¸­æ·»åŠ å­å…ƒç´ 
            $(li).append('<input type="text" class="txt">'); // å¾€liä¸­æ·»åŠ å­å…ƒç´ 
            $(li).append('<span class="time"></span>') // å¾€liä¸­æ·»åŠ å­å…ƒç´ 
            $(li).append('<a href="javascript:;" class="del">&#xe604;</a>'); // å¾€liä¸­æ·»åŠ å­å…ƒç´ 

            $(li).children('.txt').val(ele.title); // å¯¹liä¸­çš„æ–‡æœ¬æ¡†valueå±æ€§èµ‹å€¼
            $(li).children('.ok').prop('checked', ele.done) // å¯¹liä¸­çš„å¤é€‰æ¡†checkedå±æ€§èµ‹å€¼
            $(li).children('.time').html(ele.time) // å¯¹liä¸­çš„.timeç›’å­æ–‡æœ¬èµ‹å€¼

            if ($(li).children('.ok').prop('checked')) { // æ ¹æ®liçš„å¤é€‰æ¡†checkedå±æ€§ï¼Œåˆ¤æ–­æ˜¯åŠ åˆ°.doneè¿˜æ˜¯.doing
                $('.done').prepend(li);
                $(li).fadeIn(function () { // åŠ¨ç”»æ·¡å…¥
                    $(this).show();
                })
                doneNum++;
            } else {
                $('.doing').prepend(li);
                $(li).fadeIn(function () { // åŠ¨ç”»æ·¡å…¥
                    $(this).show();
                })
                doingNum++;
            }
        })

        $('.doing-num').html(doingNum); // è¿˜è¦å°†doingå³è¾¹å°æ³¡æ³¡é‡Œçš„æ•°å­—æ¸²æŸ“
        $('.done-num').html(doneNum); // è¿˜è¦å°†doneå³è¾¹å°æ³¡æ³¡é‡Œçš„æ•°å­—æ¸²æŸ“
    }

    // -------------------------- ğŸ˜ å°è£…å‡½æ•° getNowTime()ï¼šè·å–å½“å‰æ—¶é—´ï¼ˆå¹´-æœˆ-æ—¥ æ—¶:åˆ†ï¼‰ --------------------------

    function getNowTime() {
        var date = new Date();
        var year = date.getFullYear();
        var month = date.getMonth() + 1; // æœˆä»½+1
        var dates = date.getDate();
        var days = date.getDay();
        var daysArr = ['æ˜ŸæœŸå¤©', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­', ] //å‘¨æ—¥å¿…é¡»å†™åœ¨æœ€å‰é¢
        var h = date.getHours();
        var m = date.getMinutes();
        var s = date.getSeconds();

        h = h < 10 ? '0' + h : h;
        m = m < 10 ? '0' + m : m;
        s = s < 10 ? '0' + s : s;

        var myTime = year + '-' + month + '-' + dates + ' ' + h + ':' + m;
        return myTime;
    }

    // --------------------------â›„ åŠŸèƒ½:é¡µé¢åŠ è½½å®Œæ¯•å°±é©¬ä¸Šæ¸²æŸ“ä¸€æ¬¡æœ¬åœ°å­˜å‚¨åˆ°é¡µé¢ä¸­ â›„--------------------------
    load();

    // --------------------------ğŸ™‰ äº‹ä»¶ï¼šæŒ‰ä¸‹å›è½¦(CRçš„ASCIIå€¼=13) ğŸ™‰--------------------------
    $('.add-list').on('keyup', function (e) {
        // --------------------------â›„ åŠŸèƒ½ï¼šè¾“å…¥ä¸èƒ½ä¸ºç©º â›„--------------------------
        if (!$(this).val()) {
            alert('è¯·è¾“å…¥å†…å®¹åæäº¤ï¼')
            return false;
        }
        // --------------------------â›„ åŠŸèƒ½ï¼šæŠŠæ–°æ•°æ®æ·»åŠ åˆ°æœ¬åœ°å­˜å‚¨ä¸­ â›„--------------------------
        if (e.keyCode == 13) {
            var arr = getData(); // å…ˆè¯»å–æœ¬åœ°å­˜å‚¨åŸæ¥çš„æ•°ç»„æ•°æ®
            arr.push({ // æŠŠæ–°çš„æ•°æ®è¿½åŠ ç»™arræ•°ç»„ï¼Œpush()
                title: $(this).val(), // titleä¿å­˜ç”¨æˆ·è¾“å…¥å†…å®¹
                time: getNowTime(),
                done: false, // åˆšè¾“å…¥çš„ï¼Œè‚¯å®šæ˜¯æ­£åœ¨è¿›è¡Œçš„
            });
            saveData(arr); // é‡æ–°æœ¬åœ°å­˜å‚¨

            // --------------------------â›„ åŠŸèƒ½ï¼šå°†æœ¬åœ°å­˜å‚¨æ•°æ®æ¸²æŸ“åˆ°åŠ è½½é¡µé¢ä¸­ â›„--------------------------
            load();

            // --------------------------â›„ åŠŸèƒ½ï¼šæ“ä½œå®Œæˆåï¼Œæ¸…ç©ºç”¨æˆ·è¾“å…¥ â›„--------------------------
            $(this).val('');
        }
    })


    // --------------------------ğŸ™‰ äº‹ä»¶ï¼šç‚¹å‡»åˆ é™¤,åˆ é™¤æ˜¯åŠ¨æ€å…ƒç´ ,ä½¿ç”¨äº‹ä»¶å¤„ç†on() ğŸ™‰--------------------------
    $('.doing,.done').on('click', '.del', function () {
        // --------------------------â›„ åŠŸèƒ½ï¼šè¢«ç‚¹å‡»çš„æ•°æ®ä»æœ¬åœ°å­˜å‚¨ä¸­åˆ é™¤(å®é™…ä¸Šæ˜¯ä»æ•°ç»„ä¸­åˆ é™¤æŒ‡å®šå…ƒç´ ) â›„--------------------------
        let arr = getData(); // è·å–æœ¬åœ°æ•°æ®ï¼šæ•°ç»„
        let index = $(this).parent().attr('index') // è·å–è¢«ç‚¹å‡»liçš„è‡ªå®šä¹‰ç´¢å¼•å·
        arr.splice(index, 1); // æ ¹æ®ç´¢å¼•å·ï¼Œä»æ•°ç»„ä¸­åˆ é™¤æŒ‡å®šå…ƒç´ ï¼šsplice(å¼€å§‹ç´¢å¼•ï¼Œåˆ é™¤ä¸ªæ•°)
        saveData(arr); // å›ä¼ æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        load(); // é‡æ–°æ¸²æŸ“é¡µé¢
    })

    // --------------------------ğŸ™‰ äº‹ä»¶ï¼š.doingå’Œ.done æ·»åŠ  changeäº‹ä»¶å§”æ‰˜ï¼Œå¤é€‰æ¡†æ˜¯åŠ¨æ€å…ƒç´ ,ä½¿ç”¨äº‹ä»¶å¤„ç†on() ğŸ™‰--------------------------
    $(".doing,.done").on('change', '.ok', function () {
        // --------------------------â›„ åŠŸèƒ½ï¼šç‚¹å‡»å¤é€‰æ¡†åï¼Œè®©arræ•°æ®ä¸­å¯¹åº”çš„doneæ•°æ®å–å â›„--------------------------
        let arr = getData(); // è·å–æœ¬åœ°æ•°æ®ï¼Œæ•°ç»„
        let index = $(this).parent().attr('index') // è·å–ç‚¹å‡»å¤é€‰æ¡†æ‰€åœ¨liçš„è‡ªå®šä¹‰ç´¢å¼•å·index
        arr[index].done = $(this).prop('checked'); // function()æ˜¯å›è°ƒå‡½æ•°ï¼æ­¤æ—¶çš„checkedå±æ€§æ˜¯å·²ç»å–åäº†çš„
        saveData(arr);
        load();
    })

    // --------------------------ğŸ™‰ äº‹ä»¶ï¼š.doingå’Œ.done æ·»åŠ changeå’Œbluräº‹ä»¶å§”æ‰˜ï¼Œå¤é€‰æ¡†æ˜¯åŠ¨æ€å…ƒç´ ,ä½¿ç”¨äº‹ä»¶å¤„ç†on() ğŸ™‰--------------------------
    $('.doing,.done').on('change blur', '.txt', function () {
        // --------------------------â›„ åŠŸèƒ½ï¼šä¿®æ”¹.txt æ–‡æœ¬æ¡†çš„valueå±æ€§ï¼Œç„¶åé‡æ–°æ¸²æŸ“ â›„--------------------------
        let arr = getData(); // è·å–æœ¬åœ°æ•°æ®ï¼Œæ•°ç»„
        let index = $(this).parent().attr('index'); // è·å–è¢«ä¿®æ”¹æ–‡æœ¬æ¡†æ‰€åœ¨liçš„è‡ªå®šä¹‰å±æ€§index
        arr[index].title = $(this).val(); // æ•°ç»„arrä¿®æ”¹æŒ‡å®šç´¢å¼•indexçš„å…ƒç´ çš„titleå±æ€§
        saveData(arr);
        load();
        // --------------------------â›„ åŠŸèƒ½ï¼š.txt æ–‡æœ¬æ¡†æ”¹å˜åï¼Œç§»é™¤ç±»åï¼Œå¤±å»è¾¹æ¡† â›„--------------------------
        $(this).removeClass('current');
    })


    // --------------------------ğŸ™‰ äº‹ä»¶ï¼š.doingå’Œ.done æ·»åŠ focusäº‹ä»¶å§”æ‰˜ï¼Œå¤é€‰æ¡†æ˜¯åŠ¨æ€å…ƒç´ ,ä½¿ç”¨äº‹ä»¶å¤„ç†on() ğŸ™‰--------------------------
    $('.doing,.done').on('focus', '.txt', function () {
        // --------------------------â›„ åŠŸèƒ½ï¼š.txtæ–‡æœ¬æ¡†è·å¾—ç„¦ç‚¹æ—¶ï¼Œæ·»åŠ ç±»åï¼Œè·å¾—è¾¹æ¡† â›„--------------------------
        $(this).addClass('current'); // æ·»åŠ ç±»åï¼šå«è¾¹æ¡†æ ·å¼
    })
})